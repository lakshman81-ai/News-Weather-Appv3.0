<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PCF Converter â€” Piping Component File Generator</title>
  <meta name="description"
    content="Convert CSV/Excel piping data to CAESAR II PCF format. Browser-based, no installation.">

  <!-- Import Map for Main Branch (Source) Deployment -->
  <script type="importmap">
  {
    "imports": {
      "papaparse": "https://esm.sh/papaparse@5.5.3",
      "xlsx": "https://esm.sh/xlsx@0.18.5",
      "three": "https://esm.sh/three@0.160.0",
      "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <!-- App Styles -->
  <link rel="stylesheet" href="css/app.css">
</head>

<body>

  <!-- â”€â”€ Loading Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text">Processingâ€¦</div>
  </div>

  <!-- â”€â”€ App Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header id="app-header">
    <div class="app-title">
      <div class="logo-mark" aria-hidden="true"></div>
      <h1>PCF CONVERTER</h1>
      <span class="version">v1.1 (Integrated)</span>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary btn-sm" id="btn-reset-all" title="Clear all data and start over">
        â†º Reset
      </button>
    </div>
  </header>

  <!-- â”€â”€ Tab Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <nav id="tab-nav" role="tablist">
    <button class="nav-btn active" id="tab-input" role="tab" title="Input Stage">
      <i class="icon-input"></i> <span>Input</span>
    </button>
    <button class="nav-btn" id="tab-mapping" role="tab" title="Mapping Stage">
      <i class="icon-mapping"></i> <span>Enhanced Mapping</span>
    </button>
    <button class="nav-btn" id="tab-table-view" role="tab" title="PCF in Table Form">
      <i class="icon-table"></i> <span>PCF in Table Form</span>
    </button>
    <button class="nav-btn" id="tab-validate" role="tab" title="Validation Report">
      <i class="icon-validate"></i> <span>Validate</span>
    </button>
    <button class="nav-btn" id="tab-sequence" role="tab" title="Component Sequence">
      <i class="icon-sequence"></i> <span>Sequence</span>
    </button>
    <button class="nav-btn" id="tab-preview" role="tab" title="PCF Preview">
      <i class="icon-preview"></i> <span>Preview</span>
    </button>
    <button class="nav-btn" id="tab-output" role="tab" title="Generate PCF">
      <i class="icon-output"></i> <span>Output</span>
    </button>
    <button class="nav-btn" id="tab-viewer" role="tab" title="Visualize PCF">
      <i class="icon-viewer"></i> <span>3D Viewer</span>
    </button>
    <button class="nav-btn" id="tab-master-data" role="tab" title="Master Data Management">
      <i class="icon-database"></i> <span>Master Data</span>
    </button>
    <button class="nav-btn" id="tab-config" role="tab" title="Settings">
      <i class="icon-config"></i> <span>Config</span>
    </button>
  </nav>

  <!-- â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main id="app-main">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘  INPUT TAB
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="panel-input" class="tab-panel" role="tabpanel">

      <div class="flex gap-1 items-center mb-1">
        <h2 style="font-family:var(--font-code);font-size:0.9rem;color:var(--amber)">INPUT DATA</h2>
        <span id="filename-label" class="text-muted text-xs text-code" style="margin-left:auto"></span>
      </div>

      <!-- File Upload / Drop Zone -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">File Upload</span>
          <div class="flex gap-1">
            <button class="btn btn-secondary btn-sm" id="btn-paste-toggle">âŒ— Paste CSV</button>
            <button class="btn btn-secondary btn-sm" id="btn-clear">âœ• Clear</button>
          </div>
        </div>
        <div class="panel-body">

          <input type="file" id="file-input" accept=".csv,.xlsx,.xls,.txt" style="display:none">

          <div id="drop-zone">
            <svg class="drop-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.338-2.32 2.75 2.75 0 0 1 3.072 2.955A2.75 2.75 0 0 1 18 19.5H6.75Z" />
            </svg>
            <div class="drop-text-main">Drop CSV or Excel file here</div>
            <div class="drop-text-sub">or click to browse &nbsp;Â·&nbsp; <span>.csv &nbsp; .xlsx &nbsp; .xls</span></div>
          </div>

          <!-- Paste Area -->
          <div id="paste-area">
            <textarea id="paste-textarea"
              placeholder="Paste tab-separated or comma-separated data hereâ€¦&#10;First row should be column headers."></textarea>
            <div class="flex gap-1 mt-1">
              <button class="btn btn-primary btn-sm" id="btn-parse">â–¶ Parse</button>
            </div>
          </div>

          <!-- Error / Warning Banner -->
          <div id="input-error" style="display:none" class="issue-item ERROR mt-1"></div>

        </div>
      </div>

      <!-- Parse Stats -->
      <div id="parse-stats" style="display:none"></div>

      <!-- Header Mapping -->
      <div id="header-map-wrap" style="display:none" class="panel">
        <div class="panel-header">
          <span class="panel-title">Column Header Mapping</span>
          <span class="text-muted text-xs">Unrecognised headers shown in red â€” add aliases in âš™ CONFIG</span>
        </div>
        <div class="panel-body" style="padding:0">
          <div class="data-table-wrap">
            <table class="data-table" id="header-map-table">
              <thead>
                <tr>
                  <th>CSV Header</th>
                  <th>Canonical Name</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Data Preview -->
      <div id="preview-wrap" style="display:none" class="panel">
        <div class="panel-header">
          <span class="panel-title">Data Preview</span>
          <span class="text-muted text-xs" id="preview-count"></span>
        </div>
        <div class="panel-body" style="padding:0;overflow:auto">
          <div class="data-table-wrap" style="max-height:360px">
            <table class="data-table" id="preview-table"></table>
          </div>
        </div>
      </div>

    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘¡ MAPPING TAB
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="panel-mapping" class="tab-panel" role="tabpanel">
      <div class="flex gap-1 items-center mb-1">
        <h2 style="font-family:var(--font-code);font-size:0.9rem;color:var(--amber)">COMPONENT MAPPING</h2>
        <div id="mapping-convert-msg" class="issue-item INFO" style="display:none;margin-left:1rem;flex:1"></div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Component Groups</span>
          <div class="flex gap-1">
            <button class="btn btn-secondary btn-sm" id="btn-refresh-mapping">â†» Refresh</button>
            <button class="btn btn-secondary btn-sm" id="btn-regroup">â†º Re-group</button>
            <button class="btn btn-primary btn-sm" id="btn-convert">â–¶ Next â†’</button>
          </div>
        </div>
        <div class="panel-body">
          <div id="mapping-empty" class="text-muted text-sm" style="padding:2rem;text-align:center">
            Load and parse a CSV file in the INPUT tab first.
          </div>
          <div id="mapping-table-wrap" style="display:none">
            <div class="data-table-wrap">
              <table class="data-table" id="mapping-table">
                <thead>
                  <tr>
                    <th>RefNo</th>
                    <th>CSV Type</th>
                    <th>PCF Keyword</th>
                    <th>Points</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘¢ VALIDATE TAB
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="panel-validate" class="tab-panel" role="tabpanel">
      <div class="flex gap-1 items-center mb-1">
        <h2 style="font-family:var(--font-code);font-size:0.9rem;color:var(--amber)">VALIDATION REPORT</h2>
        <div class="flex gap-1" style="margin-left:auto">
          <button class="btn btn-primary btn-sm" id="btn-run-validation">â–¶ Run Validation</button>
          <div style="width:1px;background:var(--steel);margin:0 0.25rem"></div>
          <button class="btn btn-secondary btn-sm" id="btn-filter-all" data-filter="all">All</button>
          <button class="btn btn-danger    btn-sm" id="btn-filter-error" data-filter="ERROR">Errors</button>
          <button class="btn btn-secondary btn-sm" id="btn-filter-warning" data-filter="WARNING">Warnings</button>
          <button class="btn btn-secondary btn-sm" id="btn-filter-info" data-filter="INFO">Info</button>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <!-- Issue list -->
        <div class="panel">
          <div class="panel-header"><span class="panel-title">Issues</span></div>
          <div class="panel-body">
            <div id="validate-empty" class="text-muted text-sm" style="text-align:center;padding:2rem">
              Run validation to see issues here.
            </div>
            <div id="issue-list" class="issue-list" style="display:none"></div>
          </div>
        </div>
        <!-- Issue detail -->
        <div class="panel">
          <div class="panel-header"><span class="panel-title">Detail & Fix</span></div>
          <div class="panel-body">
            <div id="issue-detail" class="text-muted text-sm" style="text-align:center;padding:2rem">
              Click an issue to see details and fix options.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘£ SEQUENCE TAB
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="panel-sequence" class="tab-panel" role="tabpanel">
      <div class="flex gap-1 items-center mb-1">
        <h2 style="font-family:var(--font-code);font-size:0.9rem;color:var(--amber)">COMPONENT SEQUENCE</h2>
      </div>
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Routing Order</span>
          <div class="flex gap-1">
            <button class="btn btn-secondary btn-sm" id="btn-sort-coords">â‡… Sort by Coordinates</button>
            <button class="btn btn-primary    btn-sm" id="btn-apply-sequence" disabled>âœ“ Apply Order</button>
          </div>
        </div>
        <div class="panel-body">
          <p class="text-muted text-sm mb-2">
            Components are shown in PCF output order. Use "Sort by Coordinates" to re-order by nearest-neighbour from
            the START node. Drag rows to manually reorder.
          </p>
          <div id="sequence-empty" class="text-muted text-sm" style="text-align:center;padding:2rem">
            Convert components first in the MAPPING tab.
          </div>
          <div id="sequence-list" style="display:none"></div>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘¤ PREVIEW TAB
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="panel-preview" class="tab-panel" role="tabpanel">
      <div class="flex gap-1 items-center mb-1">
        <h2 style="font-family:var(--font-code);font-size:0.9rem;color:var(--amber)">PCF PREVIEW</h2>
        <div class="flex gap-1" style="margin-left:auto">
          <button class="btn btn-secondary btn-sm" id="btn-validate-syntax">âš‘ Validate Syntax</button>
          <button class="btn btn-secondary btn-sm" id="btn-copy-pcf">âŽ˜ Copy</button>
        </div>
      </div>
      <div class="panel" style="flex:1">
        <div class="panel-header">
          <span class="panel-title">Generated PCF</span>
          <span class="text-muted text-xs" id="pcf-line-count"></span>
        </div>
        <div class="panel-body" style="padding:0">
          <div id="pcf-preview" style="min-height:400px">
            <span
              style="color:var(--text-muted);font-family:var(--font-code);font-size:0.8rem;display:block;padding:2rem;text-align:center">
              No PCF generated yet. Process input data first.
            </span>
          </div>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘¥ OUTPUT TAB
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="panel-output" class="tab-panel" role="tabpanel">
      <div class="flex gap-1 items-center mb-1">
        <h2 style="font-family:var(--font-code);font-size:0.9rem;color:var(--amber)">OUTPUT</h2>
      </div>

      <!-- Generate + Download -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Generate PCF</span>
        </div>
        <div class="panel-body">
          <button class="btn btn-primary btn-lg" id="btn-generate">âš™ Generate PCF</button>
          <button class="btn btn-success btn-lg" id="btn-download-pcf" disabled>â†“ Download .pcf</button>
          <button class="btn btn-secondary btn-lg" id="btn-download-pcf-filtered" disabled
            title="Remove components with warnings/errors and download" style="margin-left:0.5rem">â†“ Download
            (Filtered)</button>
          <span id="validation-summary" class="text-muted text-sm" style="margin-left:1rem"></span>
        </div>
        <div id="output-error" style="display:none;margin-top:0.75rem" class="issue-item ERROR"></div>
      </div>
      </div>

      <!-- PCF Preview -->
      <div class="panel" style="flex:1">
        <div class="panel-header">
          <span class="panel-title">PCF Preview</span>
        </div>
        <div class="panel-body" style="padding:0">
          <div id="pcf-preview-output" style="
          font-family:var(--font-code);font-size:0.75rem;
          background:var(--bg-0);padding:1rem;
          min-height:200px;max-height:400px;overflow:auto;
          color:var(--text-primary);
          white-space:pre;
        ">
            <span style="color:var(--text-muted)">Generate PCF to see preview...</span>
          </div>
        </div>
      </div>

      <!-- Log Viewer -->
      <div class="panel" style="flex:1">
        <div class="panel-header">
          <span class="panel-title">Conversion Log</span>
          <button class="btn btn-secondary btn-sm" id="btn-download-log">â†“ Download Log</button>
        </div>
        <div class="panel-body" style="padding:0">
          <div id="log-output" style="
          font-family:var(--font-code);font-size:0.75rem;
          background:var(--bg-0);padding:1rem;
          min-height:200px;max-height:400px;overflow:auto;
          color:var(--text-muted);
        ">
            <span style="color:var(--text-muted)">No log entries yet.</span>
          </div>
        </div>
      </div>

    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘¦ 3D VIEWER TAB
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="panel-viewer" class="tab-panel" role="tabpanel">

      <div class="flex gap-1 items-center mb-1">
        <h2 style="font-family:var(--font-code);font-size:0.9rem;color:var(--amber)">3D VIEWER</h2>
        <div class="flex gap-1" style="margin-left:auto">
          <span id="viewer-status" class="text-muted text-sm"></span>
        </div>
      </div>

      <div style="display:flex;gap:1rem;flex:1;min-height:0">

        <!-- Left: PCF Input -->
        <div class="panel" style="width:300px;display:flex;flex-direction:column;flex-shrink:0">
          <div class="panel-header">
            <span class="panel-title">PCF Input</span>
            <div class="flex gap-1">
              <button class="btn btn-secondary btn-sm" id="btn-viewer-open" title="Open a .pcf file from disk">ðŸ“‚ Open
                File</button>
              <button class="btn btn-secondary btn-sm" id="btn-viewer-load" title="Load generated PCF from Output tab">â†‘
                Load PCF</button>
              <input type="file" id="viewer-file-input" accept=".pcf,.txt" style="display:none">
            </div>
          </div>
          <div class="panel-body" style="padding:0;flex:1;display:flex;flex-direction:column">
            <textarea id="viewer-pcf-input"
              placeholder="Paste PCF content here, or click Load PCF to use the generated outputâ€¦" style="
            flex:1;width:100%;border:none;resize:none;outline:none;
            background:var(--bg-0);color:var(--text-code);
            font-family:var(--font-code);font-size:0.75rem;
            padding:0.75rem;
          "></textarea>
          </div>
          <div style="padding:0.5rem;border-top:1px solid var(--steel);display:flex;gap:0.5rem;align-items:center">
            <label class="text-muted text-xs" for="viewer-tolerance">Tolerance (mm):</label>
            <input class="config-input" id="viewer-tolerance" type="number" step="0.5" value="6.0"
              style="width:60px;font-size:0.75rem">
            <button class="btn btn-primary btn-sm" id="btn-viewer-generate" style="margin-left:auto">â–¶ Generate
              3D</button>
          </div>
        </div>

        <!-- Centre: Visualization -->
        <div style="flex:1;display:flex;flex-direction:column;min-width:0">
          <!-- View toggle -->
          <div style="display:flex;gap:0;margin-bottom:0.5rem">
            <button class="btn btn-sm viewer-toggle-btn active" id="btn-viewer-3d">ðŸ§Š 3D View</button>
            <button class="btn btn-sm viewer-toggle-btn" id="btn-viewer-table">ðŸ“Š Data Table</button>
          </div>

          <!-- Canvas Container -->
          <div id="viewer-canvas-wrap"
            style="flex:1;min-height:400px;border-radius:var(--radius-md);overflow:hidden;border:1px solid var(--steel);position:relative">
          </div>

          <!-- Table Container -->
          <div id="viewer-table-wrap"
            style="flex:1;min-height:400px;display:none;border-radius:var(--radius-md);overflow:auto;border:1px solid var(--steel)">
          </div>

          <!-- Log Panel -->
          <div class="panel" style="margin-top:0.5rem;max-height:150px">
            <div class="panel-header">
              <span class="panel-title">System Logs</span>
            </div>
            <div class="panel-body" style="padding:0.5rem;overflow-y:auto;max-height:110px">
              <div id="viewer-log" style="font-family:var(--font-code);font-size:0.72rem">
                <span style="color:var(--text-muted)">No log entries yet.</span>
              </div>
            </div>
          </div>
        </div>

      </div>

    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘§ PCF TABLE TAB
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="panel-table-view" class="tab-panel" role="tabpanel">
      <div class="flex gap-1 items-center mb-1">
        <h2 style="font-family:var(--font-code);font-size:0.9rem;color:var(--amber)">PCF IN TABLE FORM</h2>
        <div class="flex gap-1 items-center" style="margin-left:auto">
          <label class="text-muted text-xs" for="pcf-table-tolerance">Tolerance (mm):</label>
          <input class="config-input" id="pcf-table-tolerance" type="number" step="1" value="6"
            style="width:60px;font-size:0.75rem">
          <button class="btn btn-secondary btn-sm" id="btn-refresh-table">â†º Refresh</button>
          <button class="btn btn-primary btn-sm" id="btn-regenerate-pcf" style="background:var(--green-ok)">âŸ³ Regenerate
            PCF</button>
          <button class="btn btn-secondary btn-sm" id="btn-export-phase1"
            title="Download original uploaded PCF (Phase 1)">ðŸ“¥ Export Phase 1 PCF</button>
          <button class="btn btn-primary btn-sm" id="btn-export-table">â†“ Export CSV</button>
          <button class="btn btn-primary btn-sm" id="btn-next-phase2"
            style="background:var(--amber);font-weight:600">Next â†’</button>
        </div>
      </div>
      <div class="panel" style="flex:1;display:flex;flex-direction:column;overflow:hidden">
        <div class="panel-body" style="padding:0;flex:1;overflow:auto" id="pcf-table-container">
          <div style="padding:2rem;text-align:center;color:var(--text-muted)">
            No data available. Convert components first.
          </div>
        </div>
      </div>

      <!-- Diagnostic Log Panel -->
      <div class="panel" style="max-height:250px;margin-top:0.5rem">
        <div class="panel-header">
          <span class="panel-title">Mapping Diagnostic Log</span>
          <button class="btn btn-secondary btn-sm" id="btn-clear-mapping-log">Clear</button>
        </div>
        <div class="panel-body" style="padding:0.5rem;overflow-y:auto;max-height:200px">
          <div id="mapping-diagnostic-log" style="font-family:var(--font-code);font-size:0.72rem;white-space:pre-wrap">
            <span style="color:var(--text-muted)">Click Refresh to see detailed mapping diagnostics...</span>
          </div>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘¨ CONFIG TAB
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="panel-config" class="tab-panel" role="tabpanel">

      <div class="flex gap-1 items-center mb-1">
        <h2 style="font-family:var(--font-code);font-size:0.9rem;color:var(--amber)">CONFIGURATION</h2>
        <div class="flex gap-1" style="margin-left:auto">
          <button class="btn btn-secondary btn-sm" id="btn-export-config">â†“ Export JSON</button>
          <button class="btn btn-secondary btn-sm" id="btn-import-config">â†‘ Import JSON</button>
          <button class="btn btn-danger    btn-sm" id="btn-reset-config">â†º Reset Defaults</button>
        </div>
      </div>

      <!-- Output Settings -->
      <div class="config-section open">
        <div class="config-section-header">
          <span class="config-section-title">Output Settings</span>
          <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <polyline points="6 9 12 15 18 9" />
          </svg>
        </div>
        <div class="config-section-body">
          <div class="config-row">
            <label class="config-label" for="cfg-pipelineRef">Pipeline Reference</label>
            <input class="config-input" id="cfg-pipelineRef" type="text" placeholder="e.g. TMP-2 or NEWLINE NO.">
          </div>
          <div class="config-row">
            <label class="config-label" for="cfg-projectId">Project Identifier</label>
            <input class="config-input" id="cfg-projectId" type="text" placeholder="P1">
          </div>
          <div class="config-row">
            <label class="config-label" for="cfg-area">Area</label>
            <input class="config-input" id="cfg-area" type="text" placeholder="A1">
          </div>
          <div class="config-row">
            <label class="config-label" for="cfg-lineEnding">Line Ending</label>
            <select class="config-select" id="cfg-lineEnding">
              <option value="CRLF">CRLF (Windows â€” required for CAESAR II)</option>
              <option value="LF">LF (Unix)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Coordinate Settings -->
      <div class="config-section">
        <div class="config-section-header">
          <span class="config-section-title">Coordinate Settings</span>
          <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <polyline points="6 9 12 15 18 9" />
          </svg>
        </div>
        <div class="config-section-body">
          <div class="config-row">
            <label class="config-label"
              data-tip="Maximum distance (mm) between endpoints for them to be considered connected">Continuity
              Tolerance (mm)</label>
            <input class="config-input" id="cfg-tolerance" type="number" step="0.1" min="0" value="0.5">
          </div>
          <div class="config-row">
            <label class="config-label">Decimal Places</label>
            <input class="config-input" id="cfg-decimals" type="number" min="1" max="8" value="4">
          </div>
          <div class="config-row">
            <label class="config-label">Include MESSAGE-SQUARE</label>
            <div class="toggle-wrap">
              <button class="toggle on" id="cfg-msgSquare" role="switch"></button>
              <span class="text-muted text-xs" id="cfg-msgSquare-lbl">Enabled</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Overlap Resolution -->
      <div class="config-section">
        <div class="config-section-header">
          <span class="config-section-title">Overlap Resolution</span>
          <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <polyline points="6 9 12 15 18 9" />
          </svg>
        </div>
        <div class="config-section-body">
          <p class="text-muted text-sm mb-2">Detects PIPE components whose coordinates engulf inner components and
            splits them into shorter sub-pipes. Disable for CSVs that already provide correct pipe spool endpoint
            lengths.</p>
          <div class="config-row">
            <label class="config-label">Enable Overlap Resolution</label>
            <div class="toggle-wrap">
              <button class="toggle on" id="cfg-overlapRes-enabled" role="switch"></button>
              <span class="text-muted text-xs" id="cfg-overlapRes-enabled-lbl">Enabled</span>
            </div>
          </div>
          <div class="config-row">
            <label class="config-label"
              data-tip="Max bore difference (mm) to treat a component as on the same pipe run">Bore Tolerance
              (mm)</label>
            <input class="config-input" id="cfg-overlapRes-boreTolerance" type="number" step="0.1" min="0" value="1.0">
          </div>
          <div class="config-row">
            <label class="config-label"
              data-tip="Minimum gap length (mm) to generate a sub-pipe. Gasket gaps (3mm) are skipped.">Min Sub-pipe
              Length (mm)</label>
            <input class="config-input" id="cfg-overlapRes-minPipeLength" type="number" step="0.5" min="0" value="10.0">
          </div>
          <!-- Core Logic help/info box â€” collapsible -->
          <div class="config-row" style="margin-top:12px;align-items:center;">
            <label class="config-label" style="font-weight:600;">Core Logic</label>
            <div class="toggle-wrap">
              <button class="toggle" id="cfg-overlapRes-coreLogic" role="switch"
                style="font-size:0.7rem;padding:2px 8px;" aria-expanded="false">Show</button>
            </div>
          </div>
          <div id="cfg-overlapRes-coreLogic-panel" style="display:none;margin-top:6px;">
            <pre
              style="font-size:0.72rem;line-height:1.5;white-space:pre-wrap;background:var(--bg-subtle,#f5f5f5);border-radius:6px;padding:10px;color:var(--text-muted);">CSV Row
â”” row.RefNo    â†’ grouping key (one ComponentGroup per unique RefNo)
â”” row.Point    â†’ pts dictionary key ('1', '2', '0', '3')
â”” row.East / North / Up â†’ coordinate values stored in pts[point]
â”” row.Bore     â†’ bore value stored in pts[point]

ComponentGroup.pts['1'] â†’ EP1 coordinate
ComponentGroup.pts['2'] â†’ EP2 coordinate
ComponentGroup.pts['0'] â†’ Centre / Support coordinate
ComponentGroup.pts['3'] â†’ Branch point (TEE / OLET)

Writer â†’ PCF END-POINT / CENTRE-POINT / BRANCH1-POINT lines

This is why the overlap resolver works: it creates synthetic
pts['1'] and pts['2'] entries with computed gap-endpoint
coordinates on the sub-pipe groups â€” exactly the same structure
the writers expect.</pre>
          </div>
        </div>
      </div>

      <!-- Input & Parse Settings -->
      <div class="config-section">
        <div class="config-section-header">
          <span class="config-section-title">Input & Parse Settings</span>
          <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <polyline points="6 9 12 15 18 9" />
          </svg>
        </div>
        <div class="config-section-body">
          <p class="text-muted text-sm mb-2">Controls how CSV/TSV files are parsed and how input data is cleaned before
            processing.</p>

          <div class="config-row">
            <label class="config-label"
              data-tip="Use PapaParse step mode for incremental row processing. Better for files >10K rows.">Streaming
              Parse</label>
            <div class="toggle-wrap">
              <button class="toggle" id="cfg-streamingParse" role="switch"></button>
              <span class="text-muted text-xs" id="cfg-streamingParse-lbl">Disabled</span>
            </div>
          </div>
          <div class="config-row">
            <label class="config-label" data-tip="Number of rows processed per chunk in streaming mode.">Chunk
              Size</label>
            <input class="config-input" id="cfg-streamingChunkSize" type="number" min="100" max="5000" step="100"
              value="500" style="max-width:100px">
          </div>

          <hr style="border:0;border-top:1px solid var(--steel);margin:0.75rem 0;">
          <p class="text-muted text-xs mb-1" style="font-weight:600;letter-spacing:0.05em;">SANITIZATION</p>

          <div class="config-row">
            <label class="config-label"
              data-tip="Trim leading/trailing whitespace from all cell values and headers.">Trim Whitespace</label>
            <div class="toggle-wrap">
              <button class="toggle on" id="cfg-san-trim" role="switch"></button>
              <span class="text-muted text-xs" id="cfg-san-trim-lbl">Enabled</span>
            </div>
          </div>
          <div class="config-row">
            <label class="config-label"
              data-tip="Remove UTF-8 BOM character (&#xFEFF;) from start of file. Common in Excel exports.">Strip
              BOM</label>
            <div class="toggle-wrap">
              <button class="toggle on" id="cfg-san-bom" role="switch"></button>
              <span class="text-muted text-xs" id="cfg-san-bom-lbl">Enabled</span>
            </div>
          </div>
          <div class="config-row">
            <label class="config-label"
              data-tip="Convert smart quotes (''), em-dashes (â€”), and non-breaking spaces to standard ASCII.">Normalize
              Unicode</label>
            <div class="toggle-wrap">
              <button class="toggle on" id="cfg-san-unicode" role="switch"></button>
              <span class="text-muted text-xs" id="cfg-san-unicode-lbl">Enabled</span>
            </div>
          </div>
          <div class="config-row">
            <label class="config-label"
              data-tip="Collapse multiple consecutive spaces in headers to a single space.">Collapse Spaces</label>
            <div class="toggle-wrap">
              <button class="toggle on" id="cfg-san-collapse" role="switch"></button>
              <span class="text-muted text-xs" id="cfg-san-collapse-lbl">Enabled</span>
            </div>
          </div>
          <div class="config-row">
            <label class="config-label"
              data-tip="Force all headers to lowercase before alias matching. Useful for case-sensitive systems.">Lowercase
              Headers</label>
            <div class="toggle-wrap">
              <button class="toggle" id="cfg-san-lowercase" role="switch"></button>
              <span class="text-muted text-xs" id="cfg-san-lowercase-lbl">Disabled</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Component Type Map -->
      <div class="config-section">
        <div class="config-section-header">
          <span class="config-section-title">Component Type Map (CSV â†’ PCF)</span>
          <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <polyline points="6 9 12 15 18 9" />
          </svg>
        </div>
        <div class="config-section-body">
          <p class="text-muted text-sm mb-2">Map your CSV "Type" column codes to PCF keywords. Add rows for custom
            types.</p>
          <div class="data-table-wrap">
            <table class="data-table" id="type-map-table">
              <thead>
                <tr>
                  <th>CSV Type Code</th>
                  <th>PCF Keyword</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="type-map-body"></tbody>
            </table>
          </div>
          <button class="btn btn-secondary btn-sm mt-1" id="btn-add-type">+ Add Row</button>
        </div>
      </div>

      <!-- Header Aliases -->
      <div class="config-section">
        <div class="config-section-header">
          <span class="config-section-title">Column Header Aliases</span>
          <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <polyline points="6 9 12 15 18 9" />
          </svg>
        </div>
        <div class="config-section-body">
          <p class="text-muted text-sm mb-2">Comma-separated aliases for each canonical column name. Case-insensitive.
          </p>
          <div id="alias-editor"></div>
        </div>
      </div>

      <!-- CA Definitions Summary -->
      <div class="config-section">
        <div class="config-section-header">
          <span class="config-section-title">CA Attribute Definitions</span>
          <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <polyline points="6 9 12 15 18 9" />
          </svg>
        </div>
        <div class="config-section-body">
          <p class="text-muted text-sm mb-2">COMPONENT-ATTRIBUTE mapping: which CSV column feeds each CA slot, default
            values, and applicable component types.</p>
          <div id="ca-editor"></div>
        </div>
      </div>

      <!-- Anomaly Rules -->
      <div class="config-section">
        <div class="config-section-header">
          <span class="config-section-title">Anomaly Detection Rules</span>
          <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <polyline points="6 9 12 15 18 9" />
          </svg>
        </div>
        <div class="config-section-body">
          <div id="anomaly-rules-editor"></div>
        </div>
      </div>

    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â‘© MASTER DATA TAB (Integration)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="panel-master-data" class="tab-panel" role="tabpanel">
      <div id="integ-app-container">
        <!-- Content injected by MasterDataController.js -->
      </div>
    </section>

  </main>

  <!-- â”€â”€ Status Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <footer id="status-bar">
    <div class="status-item">
      <div class="status-dot idle" id="status-dot"></div>
      <span id="status-text">Ready</span>
    </div>
    <div class="status-item" id="status-rows" style="display:none">
      <span id="status-row-count" class="text-code"></span> rows
    </div>
    <div class="status-item" id="status-groups" style="display:none">
      <span id="status-group-count" class="text-code"></span> components
    </div>
    <div style="margin-left:auto;color:var(--text-muted);font-size:0.68rem">
      PCF Converter v1.0 &nbsp;Â·&nbsp; Browser-based &nbsp;Â·&nbsp; No data leaves your machine
    </div>
  </footer>


  <!-- â”€â”€ Defaults Popup Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="defaults-popup" class="modal-overlay" style="display:none">
    <div class="modal-dialog" style="max-width:95vw;max-height:90vh">
      <div class="modal-header">
        <h3 style="margin:0;font-size:1rem;color:var(--amber)">Apply Default Values</h3>
        <button class="modal-close" id="defaults-close-x"
          style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-muted)">&times;</button>
      </div>
      <div class="modal-body" style="overflow:auto;padding:1rem">
        <p class="text-muted text-sm mb-1">
          Values in <span style="color:red;font-weight:600">red</span> are defaults from Settings.
          Edit as needed, then click "Load this data" to apply.
        </p>
        <div id="defaults-table-wrapper" style="overflow:auto;max-height:60vh">
          <!-- Table injected by JS -->
        </div>
      </div>
      <div class="modal-footer"
        style="display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:1rem;border-top:1px solid var(--border)">
        <div style="flex:1;display:flex;align-items:center;gap:0.5rem">
          <span class="text-muted text-sm">Default
            <input type="number" id="ins-den-default" value="210"
              style="width:60px;padding:0.25rem 0.5rem;background:var(--bg-1);border:1px solid var(--steel);color:var(--text-primary);border-radius:4px;text-align:center" />
            kg/mÂ³ is populated as insulation density
          </span>
        </div>
        <div style="display:flex;gap:0.5rem">
          <button id="defaults-cancel" class="btn btn-secondary">Cancel</button>
          <button id="defaults-apply" class="btn btn-primary">Load this data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Boot error fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="boot-error"
    style="display:none;position:fixed;top:52px;left:0;right:0;padding:0.75rem 1.5rem;background:var(--red-dim);color:var(--red-err);font-family:var(--font-code);font-size:0.8rem;z-index:999">
  </div>

  <!-- â”€â”€ App Script (ES module) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script type="module" src="js/app.js"></script>

</body>

</html>